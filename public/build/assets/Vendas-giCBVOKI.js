import{r as o,j as e,S as ee,L as Se}from"./set-Dr3sRFX0.js";import{V as _e}from"./VendaDetalhesModal-zc7an2_t.js";import{a as Z}from"./formatters-DlcN8pLi.js";import{u as Ve,N as De,a as ke}from"./useNotifications-DCogPmXs.js";import{G as Fe}from"./GerenciamentoLayout-B_vqmClp.js";import"./ModalPortal-DqnXe3eG.js";import"./index-MyIu9ubh.js";function Q(a){return a?a.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}function ae({clientes:a,valueId:n,query:t,setValueId:c,setQuery:d,placeholder:r="Buscar cliente por nome ou e-mail...",label:m="Cliente"}){const[g,u]=o.useState(!1),[_,b]=o.useState(0),f=o.useRef(null),y=o.useRef(null),x=o.useMemo(()=>{const i=Q(t);return(i?a.filter(w=>Q(w.nome).includes(i)||Q(w.email||"").includes(i)):a).slice(0,12)},[a,t]),V=i=>i.email?`${i.nome} - ${i.email}`:i.nome,N=i=>{const s=x[i];s&&(c(String(s.id)),d(V(s)),u(!1))},j=i=>{i||c("")};return o.useEffect(()=>{if(n){const i=a.find(s=>String(s.id)===String(n));if(i){const s=V(i);t!==s&&d(s)}}else t!==""&&d("")},[n,a]),o.useEffect(()=>{const i=s=>{f.current&&(f.current.contains(s.target)||u(!1))};return document.addEventListener("mousedown",i),()=>document.removeEventListener("mousedown",i)},[]),e.jsxs("div",{className:"mb-0",ref:f,style:{position:"relative"},children:[e.jsx("label",{className:"form-label",children:m}),e.jsxs("div",{className:"position-relative",children:[e.jsx("input",{ref:y,type:"text",className:"form-control",placeholder:r,value:t,onChange:i=>{d(i.target.value),j(i.target.value),u(!0),b(0)},onFocus:()=>u(!0),onKeyDown:i=>{i.key==="ArrowDown"?(i.preventDefault(),u(!0),b(s=>Math.min(s+1,Math.max(0,x.length-1)))):i.key==="ArrowUp"?(i.preventDefault(),b(s=>Math.max(s-1,0))):i.key==="Enter"?(i.preventDefault(),g?N(_):u(!0)):i.key==="Escape"&&u(!1)},"aria-expanded":g,"aria-controls":"clientes-combobox-menu",autoComplete:"off"}),g&&e.jsx("div",{id:"clientes-combobox-menu",className:"dropdown-menu show w-100",style:{position:"absolute",top:"calc(100% + 0.25rem)",left:0,right:0,maxHeight:260,overflowY:"auto",zIndex:1080},children:x.length===0?e.jsx("div",{className:"dropdown-item text-muted",children:"Nenhum cliente encontrado"}):x.map((i,s)=>e.jsx("button",{type:"button",className:`dropdown-item ${s===_?"active":""}`,onMouseEnter:()=>b(s),onClick:()=>N(s),children:i.nome},i.id))})]})]})}function Me(a){const{carrinho:n,clientesAtualizados:t,clienteSelecionado:c,setClienteSelecionado:d,formaPagamento:r,setFormaPagamento:m,abrirModalCliente:g,desconto:u,valorRecebido:_,loadingVenda:b,setDesconto:f,setValorRecebido:y,editarQuantidade:x,removerDoCarrinho:V,limparCarrinho:N,calcularSubtotal:j,calcularTotal:i,finalizarVenda:s,cancelarVenda:w,cancelandoVenda:C,addNotification:E}=a,T=b||C,[z,h]=o.useState(""),[p,v]=o.useState(""),F=l=>l?l.toFixed(2).replace(".",",").replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1."):"";o.useEffect(()=>{if(c){const l=c.email?`${c.nome} - ${c.email}`:c.nome;h(l)}else h("")},[c]),o.useEffect(()=>{if(!u){v("");return}v(F(u))},[u]);const S=l=>{if(!l||l==="")return 0;const D=l.replace(/R\$\s?/g,"").replace(/\./g,"").replace(",","."),M=parseFloat(D);return isNaN(M)?0:M},R=()=>{const l=S(_),D=i();return l>D?l-D:0},k=l=>{const D=l.target.value;if(D===""||D==="0"){y("");return}const M=Z(D);y(M)},L=l=>{if(l===""||l==="0"){v(""),f(0);return}const D=Z(l);let M=S(D);const I=j(),P=Math.min(M,I);P!==M?(M=P,v(F(P))):v(D),f(Number(P.toFixed(2)))};return e.jsxs("div",{className:`card carrinho-container h-100 ${T?"loading":""}`,children:[e.jsx("div",{className:"card-header carrinho-header text-white",children:e.jsxs("h5",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-cart me-2"}),"Carrinho (",n.length," ",n.length===1?"item":"itens",")"]})}),e.jsxs("div",{className:"card-body d-flex flex-column",children:[e.jsx("div",{className:"carrinho-lista mb-3 flex-grow-1",children:n.length===0?e.jsxs("div",{className:"estado-vazio",children:[e.jsx("i",{className:"bi bi-cart-x display-6 d-block mb-2"}),"Carrinho vazio"]}):n.map(l=>e.jsx("div",{className:"card carrinho-item mb-2",children:e.jsxs("div",{className:"card-body p-2",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-2",children:[e.jsx("small",{className:"produto-nome me-2 flex-grow-1",children:l.produto.nome}),e.jsx("button",{className:"btn btn-sm btn-outline-danger",onClick:()=>V(l.produto_id,E),children:e.jsx("i",{className:"bi bi-trash"})})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"input-group quantidade-controles w-auto",children:[e.jsx("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>x(l.produto.id,Math.max(1,l.quantidade-1),E),type:"button",children:"-"}),e.jsx("input",{type:"number",className:"form-control form-control-sm px-0 text-center",style:{maxWidth:"48px"},value:l.quantidade,onChange:D=>x(l.produto.id,parseInt(D.target.value)||1,E),min:"1"}),e.jsx("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>x(l.produto.id,l.quantidade+1,E),type:"button",children:"+"})]}),e.jsxs("div",{className:"text-end",children:[e.jsxs("small",{className:"preco-info d-block",children:["R$ ",l.preco_unitario.toFixed(2).replace(".",",")," Ã— ",l.quantidade]}),e.jsxs("strong",{className:"subtotal",children:["R$ ",l.subtotal.toFixed(2).replace(".",",")]})]})]})]})},l.produto_id))}),n.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row mb-3",children:[e.jsxs("div",{className:"col-12 mb-3",children:[e.jsx("label",{className:"form-label small",children:"Forma de Pagamento"}),e.jsx("div",{className:"pagamento-opcoes",children:e.jsxs("div",{className:"row g-2",children:[e.jsxs("div",{className:"col-md-3 col-6",children:[e.jsx("input",{type:"radio",className:"btn-check",name:"formaPagamento",id:"dinheiro",value:"dinheiro",checked:r==="dinheiro",onChange:l=>m(l.target.value)}),e.jsxs("label",{className:"btn btn-outline-primary d-flex flex-column align-items-center w-100 py-3",htmlFor:"dinheiro",children:[e.jsx("i",{className:"bi bi-cash-coin fs-4 mb-2"}),e.jsx("span",{className:"small",children:"Dinheiro"})]})]}),e.jsxs("div",{className:"col-md-3 col-6",children:[e.jsx("input",{type:"radio",className:"btn-check",name:"formaPagamento",id:"pix",value:"pix",checked:r==="pix",onChange:l=>m(l.target.value)}),e.jsxs("label",{className:"btn btn-outline-primary d-flex flex-column align-items-center w-100 py-3",htmlFor:"pix",children:[e.jsx("i",{className:"bi bi-qr-code fs-4 mb-2"}),e.jsx("span",{className:"small",children:"PIX"})]})]}),e.jsxs("div",{className:"col-md-3 col-6",children:[e.jsx("input",{type:"radio",className:"btn-check",name:"formaPagamento",id:"cartao_debito",value:"cartao_debito",checked:r==="cartao_debito",onChange:l=>m(l.target.value)}),e.jsxs("label",{className:"btn btn-outline-primary d-flex flex-column align-items-center w-100 py-3",htmlFor:"cartao_debito",children:[e.jsx("i",{className:"bi bi-credit-card-2-front fs-4 mb-2"}),e.jsx("span",{className:"small",children:"DÃ©bito"})]})]}),e.jsxs("div",{className:"col-md-3 col-6",children:[e.jsx("input",{type:"radio",className:"btn-check",name:"formaPagamento",id:"cartao_credito",value:"cartao_credito",checked:r==="cartao_credito",onChange:l=>m(l.target.value)}),e.jsxs("label",{className:"btn btn-outline-primary d-flex flex-column align-items-center w-100 py-3",htmlFor:"cartao_credito",children:[e.jsx("i",{className:"bi bi-credit-card fs-4 mb-2"}),e.jsx("span",{className:"small",children:"CrÃ©dito"})]})]}),e.jsxs("div",{className:"col-md-6 col-12",children:[e.jsx("input",{type:"radio",className:"btn-check",name:"formaPagamento",id:"conta_fiada",value:"conta_fiada",checked:r==="conta_fiada",onChange:l=>m(l.target.value)}),e.jsxs("label",{className:"btn btn-outline-primary d-flex flex-column align-items-center w-100 py-3",htmlFor:"conta_fiada",children:[e.jsx("i",{className:"bi bi-wallet2 fs-4 mb-2"}),e.jsx("span",{className:"small",children:"Conta Fiada"})]})]})]})})]}),r==="conta_fiada"&&e.jsxs("div",{className:"col-12 mb-3",children:[e.jsx("label",{className:"form-label small d-block",children:"Cliente"}),e.jsxs("div",{className:"row g-2 align-items-end",children:[e.jsx("div",{className:"col",children:e.jsx(ae,{clientes:t,valueId:c!=null&&c.id?String(c.id):"",query:z,setValueId:l=>{if(!l){d(null);return}const D=t.find(M=>String(M.id)===String(l));d(D||null)},setQuery:h,label:"",placeholder:"Nome ou e-mail do cliente"})}),e.jsx("div",{className:"col-auto",children:e.jsx("button",{type:"button",className:"btn btn-outline-primary",onClick:g,title:"Cadastrar novo cliente",children:e.jsx("i",{className:"bi bi-plus-lg"})})})]}),!c&&e.jsxs("div",{className:"alert alert-warning alert-sm mt-2 mb-0",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-1"}),e.jsx("small",{children:"Selecione um cliente para venda fiada"})]})]})]}),r==="dinheiro"&&e.jsx("div",{className:"row",children:e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{htmlFor:"valor-recebido",className:"form-label",children:[e.jsx("i",{className:"bi bi-cash-coin me-2"}),"Valor Recebido"]}),e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"input-group-text",children:"R$"}),e.jsx("input",{type:"text",className:"form-control",id:"valor-recebido",value:_,onChange:k,onFocus:l=>{(l.target.value==="0,00"||l.target.value==="0")&&y("")},onBlur:l=>{(l.target.value===""||l.target.value==="0")&&y("")},placeholder:"0,00",style:{textAlign:"right"}})]}),R()>0&&e.jsxs("div",{className:"troco-info mt-2 text-center",children:[e.jsx("i",{className:"bi bi-arrow-return-left me-1"}),"Troco: ",e.jsxs("strong",{children:["R$ ",R().toFixed(2).replace(".",",")]})]})]})}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label small",children:"Desconto"}),e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"input-group-text",children:"R$"}),e.jsx("input",{type:"text",className:"form-control",inputMode:"decimal",value:p,onChange:l=>L(l.target.value),onFocus:l=>{(l.target.value==="0,00"||l.target.value==="0")&&v("")},onBlur:l=>{(l.target.value===""||l.target.value==="0")&&(v(""),f(0))},placeholder:"0,00",style:{textAlign:"right"}})]})]}),e.jsx("div",{className:"card resumo-venda mb-3",children:e.jsxs("div",{className:"card-body p-2",children:[e.jsxs("div",{className:"resumo-linha",children:[e.jsx("small",{children:"Subtotal:"}),e.jsxs("small",{children:["R$ ",j().toFixed(2).replace(".",",")]})]}),u>0&&e.jsxs("div",{className:"resumo-linha desconto",children:[e.jsx("small",{children:"Desconto:"}),e.jsxs("small",{children:["- R$ ",u.toFixed(2).replace(".",",")]})]}),e.jsx("div",{className:"divider"}),e.jsxs("div",{className:"resumo-linha total",children:[e.jsx("span",{children:"TOTAL:"}),e.jsxs("span",{children:["R$ ",i().toFixed(2).replace(".",",")]})]})]})}),e.jsxs("div",{className:"d-flex flex-column gap-2",children:[e.jsx("button",{type:"button",className:`btn btn-finalizar-venda w-100 ${b?"processing":""}`,onClick:s,disabled:b||C||n.length===0,children:b?e.jsx("span",{className:"fw-semibold",children:"Processando venda..."}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),"Finalizar Venda"]})}),e.jsx("button",{type:"button",className:`btn btn-finalizar-venda btn-cancelar-venda w-100 ${C?"processing":""}`,onClick:w,disabled:C||b||n.length===0,children:C?e.jsx("span",{className:"fw-semibold",children:"Cancelando venda..."}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-x-circle me-2"}),"Cancelar Venda"]})})]})]})]})]})}function Re(a){const n=d=>typeof window>"u"?!1:window.matchMedia(d).matches,[t,c]=o.useState(()=>n(a));return o.useEffect(()=>{const d=window.matchMedia(a),r=m=>{c(m.matches)};c(d.matches);try{d.addEventListener("change",r)}catch{d.addListener(r)}return()=>{try{d.removeEventListener("change",r)}catch{d.removeListener(r)}}},[a]),t}const te=a=>{if(!a)return"Data invÃ¡lida";try{return new Date(a).toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return"Data invÃ¡lida"}},se=a=>{const n=a==="conta_fiada"?"pendente":a,t=n==="concluida"?"text-bg-success":n==="pendente"?"text-bg-warning":n==="cancelada"?"text-bg-danger":"text-bg-info",c=n==="concluida"?"âœ… ConcluÃ­da":n==="pendente"?"â³ Pendente":n==="cancelada"?"âŒ Cancelada":n||"â€”";return e.jsx("span",{className:`badge ${t}`,children:c})},ne=a=>{switch(a){case"dinheiro":return e.jsxs("span",{className:"badge text-bg-success",children:[e.jsx("i",{className:"bi bi-cash-coin me-1"}),"Dinheiro"]});case"pix":return e.jsxs("span",{className:"badge text-bg-info",children:[e.jsx("i",{className:"bi bi-qr-code me-1"}),"PIX"]});case"debito":case"cartao_debito":return e.jsxs("span",{className:"badge text-bg-primary",children:[e.jsx("i",{className:"bi bi-credit-card-2-front me-1"}),"DÃ©bito"]});case"credito":case"cartao_credito":return e.jsxs("span",{className:"badge text-bg-warning text-dark",children:[e.jsx("i",{className:"bi bi-credit-card me-1"}),"CrÃ©dito"]});case"conta_fiada":case"fiado":return e.jsxs("span",{className:"badge text-bg-secondary",children:[e.jsx("i",{className:"bi bi-wallet2 me-1"}),"Conta Fiada"]});default:return e.jsxs("span",{className:"badge text-bg-light text-dark",children:[e.jsx("i",{className:"bi bi-question-circle me-1"}),a||"NÃ£o informado"]})}},le=(a=!1)=>{const n=e.jsxs("div",{className:"text-muted p-5 text-center",children:[e.jsx("i",{className:"bi bi-receipt display-4 d-block mb-3"}),e.jsx("h5",{children:"Nenhuma venda encontrada"})]});return a?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"estado-vazio",style:{padding:0},children:n})}):n},Ee=({vendasFiltradas:a,abrirDetalhes:n})=>e.jsxs("div",{className:"card fade-in",children:[e.jsx("div",{className:"card-header bg-body",children:e.jsxs("h5",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-receipt-cutoff me-2"}),"HistÃ³rico do dia (",a.length," vendas)"]})}),e.jsx("div",{className:"card-body p-0",children:e.jsx("div",{className:"table-responsive scroll-shadow",children:e.jsxs("table",{className:"table-hover vendas-table data-table mb-0 table align-middle",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Data/Hora"}),e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"Total"}),e.jsx("th",{children:"Pagamento"}),e.jsx("th",{children:"Status"}),e.jsx("th",{className:"text-center",children:"AÃ§Ãµes"})]})}),e.jsx("tbody",{children:a.length===0?le(!0):a.map(t=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"Data/Hora",children:te(t.created_at)}),e.jsx("td",{"data-label":"Cliente",children:t.cliente?e.jsx("div",{className:"cliente-nome",children:t.cliente.nome}):e.jsx("span",{className:"text-muted",children:"Venda avulsa"})}),e.jsxs("td",{"data-label":"Total",children:[e.jsx("strong",{className:"text-success",children:t.total_formatado}),t.desconto>0&&e.jsxs("small",{className:"d-block text-muted",children:["Desconto: R$ ",t.desconto.toFixed(2).replace(".",",")]})]}),e.jsx("td",{"data-label":"Pagamento",children:ne(t.forma_pagamento)}),e.jsx("td",{"data-label":"Status",children:se(t.status)}),e.jsx("td",{className:"text-center","data-label":"AÃ§Ãµes",children:e.jsxs("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>n(t),title:"Ver detalhes",children:[e.jsx("i",{className:"bi bi-eye"}),e.jsx("span",{className:"ms-2",children:"Abrir"})]})})]},t.id))})]})})})]}),Te=({vendasFiltradas:a,abrirDetalhes:n})=>e.jsxs("div",{className:"fade-in",children:[e.jsxs("h5",{className:"mb-3",children:[e.jsx("i",{className:"bi bi-receipt-cutoff me-2"}),"HistÃ³rico (",a.length," vendas)"]}),a.length===0?le(!1):a.map(t=>e.jsx("div",{className:"card mb-2 shadow-sm",children:e.jsx("div",{className:"card-body",children:e.jsxs("dl",{className:"row mb-0",style:{fontSize:"0.95rem"},children:[e.jsx("dt",{className:"text-muted col-4",children:"Data/Hora"}),e.jsx("dd",{className:"col-8",children:te(t.created_at)}),e.jsx("dt",{className:"text-muted col-4",children:"Cliente"}),e.jsx("dd",{className:"fw-bold col-8",children:t.cliente?t.cliente.nome:"Venda avulsa"}),e.jsx("dt",{className:"text-muted col-4",children:"Total"}),e.jsx("dd",{className:"fw-bold text-success fs-6 col-8",children:t.total_formatado}),e.jsx("dt",{className:"text-muted col-4",children:"Pagamento"}),e.jsx("dd",{className:"col-8",children:ne(t.forma_pagamento)}),e.jsx("dt",{className:"text-muted col-4",children:"Status"}),e.jsx("dd",{className:"col-8",children:se(t.status)}),e.jsx("dt",{className:"text-muted col-4",children:"AÃ§Ãµes"}),e.jsx("dd",{className:"col-8",children:e.jsxs("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>n(t),children:[e.jsx("i",{className:"bi bi-eye"}),e.jsx("span",{className:"ms-2",children:"Abrir"})]})})]})})},t.id))]});function qe(a){const n=Re("(min-width: 768px)"),{clientes:t,filtroStatus:c,filtroCliente:d,filtroClienteTexto:r,setFiltroStatus:m,setFiltroCliente:g,setFiltroClienteTexto:u,limparFiltros:_}=a;return e.jsx("div",{className:"row fade-in",children:e.jsxs("div",{className:"col-12",children:[e.jsx("div",{className:"card filtros-card mb-3",children:e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsxs("select",{className:"form-select",value:c,onChange:b=>m(b.target.value),children:[e.jsx("option",{value:"",children:"Todos os status"}),e.jsx("option",{value:"concluida",children:"âœ… ConcluÃ­da"}),e.jsx("option",{value:"pendente",children:"â³ Pendente (inclui Conta Fiada)"}),e.jsx("option",{value:"cancelada",children:"âŒ Cancelada"})]})]}),e.jsx("div",{className:"col-md-5",children:e.jsx(ae,{clientes:t,valueId:d,query:r,setValueId:g,setQuery:u,label:"Cliente (digite e selecione)",placeholder:"Ex.: Maria Silva"})}),e.jsx("div",{className:"col-md-3 mb-md-0 d-flex justify-content-end align-items-end col-12 mb-2",children:e.jsxs("button",{className:"btn btn-outline-secondary btn-limpar-filtros d-flex align-items-center w-md-auto w-100 gap-2 text-nowrap",onClick:_,children:[e.jsx("i",{className:"bi bi-arrow-clockwise"}),e.jsx("span",{children:"Limpar Filtros"})]})})]})})}),n?e.jsx(Ee,{...a}):e.jsx(Te,{...a})]})})}const G=20;function ze({busca:a,setBusca:n,produtosFiltrados:t,limparBusca:c,adicionarAoCarrinho:d,addNotification:r}){const[m,g]=o.useState(G),u=o.useRef(null);o.useEffect(()=>{g(G),u.current&&(u.current.scrollTop=0)},[t]);const _=o.useMemo(()=>t!=null&&t.length?t.slice(0,m):[],[t,m]),b=t.length>0,f=m<t.length,y=x=>{if(!f)return;const{scrollTop:V,scrollHeight:N,clientHeight:j}=x.currentTarget;V+j>=N-24&&g(s=>s>=t.length?s:Math.min(s+G,t.length))};return e.jsxs("div",{className:"card h-100",children:[e.jsx("div",{className:"card-header bg-primary text-white",children:e.jsxs("h5",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-shop me-2"}),"Produtos DisponÃ­veis"]})}),e.jsxs("div",{className:"card-body d-flex flex-column gap-3",children:[e.jsx("div",{children:e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"input-group-text",children:e.jsx("i",{className:"bi bi-search"})}),e.jsx("input",{type:"text",className:"form-control",placeholder:"ðŸ” Buscar produto por nome, cÃ³digo ou categoria...",value:a,onChange:x=>n(x.target.value),autoFocus:!0}),a&&e.jsx("button",{className:"btn btn-outline-secondary",onClick:c,children:e.jsx("i",{className:"bi bi-x"})})]})}),e.jsx("div",{className:`produtos-scroll-area flex-grow-1 ${f?"is-scrollable":""}`,onScroll:b&&f?y:void 0,ref:u,children:b?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"row g-2",children:_.map(x=>{var V,N,j,i;return e.jsx("div",{className:"col-md-6 col-lg-4",children:e.jsx("div",{className:"card produto-card h-100",onClick:()=>d(x,r),children:e.jsxs("div",{className:"card-body p-3",children:[e.jsx("h6",{className:"card-title text-truncate mb-2",children:x.nome}),e.jsx("p",{className:"card-text small text-muted mb-2",children:((V=x.categoria)==null?void 0:V.nome)||"Sem categoria"}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{className:"text-success",children:x.preco_formatado}),e.jsxs("small",{className:`badge ${(Number((N=x.estoque)==null?void 0:N.quantidade)||0)>5?"bg-success":(Number((j=x.estoque)==null?void 0:j.quantidade)||0)>0?"bg-warning":"bg-danger"}`,children:["Est: ",Number((i=x.estoque)==null?void 0:i.quantidade)||0]})]})]})})},x.id)})}),f&&e.jsxs("div",{className:"produtos-scroll-hint text-center small text-muted mt-3",children:["Role para visualizar mais produtos (",m,"/",t.length,")"]})]}):e.jsxs("div",{className:"estado-vazio",children:[e.jsx("i",{className:"bi bi-search display-4 d-block mb-2"}),a?"Nenhum produto encontrado":"Digite para buscar produtos"]})})]})]})}const Pe=a=>{const[n,t]=o.useState(""),c=o.useMemo(()=>{if(!n.trim())return a;const r=n.toLowerCase().trim();return a.filter(m=>{var g,u;return m.nome.toLowerCase().includes(r)||((g=m.codigo_barras)==null?void 0:g.toLowerCase().includes(r))||((u=m.categoria)==null?void 0:u.nome.toLowerCase().includes(r))})},[n,a]);return{busca:n,setBusca:t,produtosFiltrados:c,limparBusca:()=>{t("")}}},$e=a=>{if(!a)return 0;const n=a.replace(/[^0-9,]/g,"").replace(",","."),t=parseFloat(n);return Number.isFinite(t)?t:0},Le=()=>({cancelarVenda:({carrinho:n,calcularTotal:t,formaPagamento:c,valorRecebido:d,clienteSelecionado:r,getDadosVenda:m,limparCarrinho:g,setCancelandoVenda:u,setAbaAtiva:_,addNotification:b,messages:f})=>{if(n.length===0){b({type:"warning",title:"Carrinho",message:f.carrinho_vazio});return}if(!c){b({type:"warning",title:"Pagamento",message:"Selecione uma forma de pagamento antes de cancelar."});return}u(!0);const y=m(),x=$e(d),V={itens:n.map(N=>({produto_id:N.produto.id,quantidade:N.quantidade,preco_unitario:N.produto.preco})),forma_pagamento:c,desconto:y.desconto||0,observacoes:y.observacoes||null};c==="conta_fiada"&&(r!=null&&r.id)&&(V.cliente_id=r.id),c==="dinheiro"&&(V.valor_recebido=x),ee.post("/gerenciamento/vendas/cancelar-aberta",V,{preserveScroll:!0,headers:{"X-PDV-Inline":"true"},onSuccess:()=>{b({type:"success",title:"Venda Cancelada",message:f.venda_cancelada}),g(),_("lista")},onError:N=>{const j=Object.values(N),i=j.length>0?j[0]:f.erro_cancelar;b({type:"error",title:"Erro ao Cancelar",message:Array.isArray(i)?i[0]:i})},onFinish:()=>u(!1)})}});function Ae(a){const[n,t]=o.useState([]),[c,d]=o.useState(null),[r,m]=o.useState(""),[g,u]=o.useState(0),[_,b]=o.useState(""),[f,y]=o.useState(""),[x,V]=o.useState(!1),N=h=>{if(!h||h==="")return 0;const p=h.replace(/R\$\s?/g,"").replace(/\./g,"").replace(",","."),v=parseFloat(p);return isNaN(v)?0:v},j=()=>{const h=N(r),p=z();return h>p?h-p:0},i=()=>({desconto:g,observacoes:f,valorRecebido:r,valorRecebidoNumero:N(r),troco:j(),total:z()}),s=(h,p)=>{var S,R;if(n.find(k=>k.produto.id===h.id)){p&&(a!=null&&a.produto_ja_no_carrinho)&&p({type:"warning",message:a.produto_ja_no_carrinho});return}if((((S=h.estoque)==null?void 0:S.quantidade)??0)<1){p&&(a!=null&&a.estoque_insuficiente)&&p({type:"error",message:a.estoque_insuficiente.replace(":disponivel",String(((R=h.estoque)==null?void 0:R.quantidade)??0))});return}const F={produto_id:h.id,produto:h,quantidade:1,preco_unitario:h.preco,subtotal:h.preco};t(k=>[...k,F]),p&&(a!=null&&a.produto_adicionado)&&p({type:"success",message:a.produto_adicionado})},w=(h,p,v)=>{if(p<1){C(h,v);return}t(F=>F.map(S=>{var R,k;return S.produto.id===h?p>(((R=S.produto.estoque)==null?void 0:R.quantidade)??0)?(v&&(a!=null&&a.estoque_insuficiente)&&v({type:"error",message:a.estoque_insuficiente.replace(":disponivel",String(((k=S.produto.estoque)==null?void 0:k.quantidade)??0))}),S):{...S,quantidade:p,subtotal:p*S.preco_unitario}:S}))},C=(h,p)=>{t(v=>v.filter(F=>F.produto.id!==h)),p&&(a!=null&&a.produto_removido)&&p({type:"success",message:a.produto_removido})},E=()=>{t([]),m(""),u(0),b(""),y(""),d(null)},T=()=>n.reduce((h,p)=>h+p.produto.preco*p.quantidade,0),z=()=>T()-g;return{carrinho:n,clienteSelecionado:c,valorRecebido:r,desconto:g,formaPagamento:_,observacoes:f,loadingVenda:x,setClienteSelecionado:d,setValorRecebido:m,setDesconto:u,setFormaPagamento:b,setObservacoes:y,setLoadingVenda:V,adicionarAoCarrinho:s,editarQuantidade:w,removerDoCarrinho:C,limparCarrinho:E,calcularSubtotal:T,calcularTotal:z,calcularTroco:j,getDadosVenda:i}}const q=a=>a?a.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():"",Ie=a=>{const n=(a??"").toLowerCase();return n==="conta_fiada"?"pendente":n},Be=(a,n)=>{const[t,c]=o.useState(""),[d,r]=o.useState(""),[m,g]=o.useState(""),[u,_]=o.useState(null),[b,f]=o.useState(!1),y=o.useMemo(()=>{const s=q(m);if(!s)return null;const w=n.filter(C=>q(C.nome).includes(s)||q(C.email||"").includes(s)).map(C=>C.id);return new Set(w)},[n,m]),x=o.useMemo(()=>n.find(s=>String(s.id)===String(d))||null,[n,d]),V=s=>{var w;return((w=s==null?void 0:s.cliente)==null?void 0:w.id)??(s==null?void 0:s.cliente_id)??(s==null?void 0:s.clienteId)??null},N=s=>{var w;return((w=s==null?void 0:s.cliente)==null?void 0:w.nome)??(s==null?void 0:s.cliente_nome)??""},j=s=>{var w;return((w=s==null?void 0:s.cliente)==null?void 0:w.email)??(s==null?void 0:s.cliente_email)??""},i=o.useMemo(()=>{const s=!!d,w=new Date;return w.setHours(0,0,0,0),a.filter(C=>{const E=!t||Ie(C.status)===t,T=new Date(C.created_at);T.setHours(0,0,0,0);const z=T.getTime()===w.getTime(),h=V(C);let p=!0;if(s){const v=h!==null&&String(h)===String(d);let F=!1;if(!v&&x){const S=q(N(C)),R=q(j(C)),k=q(x.nome),L=q(x.email||"");F=!!k&&(S===k||S.includes(k))||!!L&&(R===L||R.includes(L))}p=v||F}else if(y)if(h!==null)p=y.has(Number(h));else{const v=q(N(C)),F=q(j(C)),S=q(m);p=!S||v.includes(S)||F.includes(S)}else p=!0;return E&&p&&z})},[a,t,d,m,y,x]);return{filtroStatus:t,filtroCliente:d,filtroClienteTexto:m,vendaSelecionada:u,showDetalhes:b,setFiltroStatus:c,setFiltroCliente:r,setFiltroClienteTexto:g,setVendaSelecionada:_,setShowDetalhes:f,vendasFiltradas:i,abrirDetalhes:s=>{_(s),f(!0)},fecharDetalhes:()=>{f(!1),_(null)},limparFiltros:()=>{c(""),r(""),g("")}}},Oe=()=>({finalizarVenda:async({carrinho:n,calcularTotal:t,formaPagamento:c,valorRecebido:d,clienteSelecionado:r,getDadosVenda:m,limparCarrinho:g,setLoadingVenda:u,setAbaAtiva:_,addNotification:b,messages:f})=>{if(n.length===0){b({type:"warning",title:"Carrinho Vazio",message:f.carrinho_vazio});return}const y=t();if(c==="dinheiro"&&(!d||parseFloat(d.replace(/[^\d,]/g,"").replace(",","."))<y)){b({type:"error",title:"Valor Insuficiente",message:f.valor_insuficiente});return}if(c==="conta_fiada"&&!r){b({type:"warning",title:"Cliente ObrigatÃ³rio",message:f.cliente_obrigatorio});return}u(!0);const x=m(),V=parseFloat(d.replace(/[^\d,]/g,"").replace(",","."))||0,N={itens:n.map(j=>({produto_id:j.produto.id,quantidade:j.quantidade,preco_unitario:j.produto.preco})),forma_pagamento:c,desconto:x.desconto||0,observacoes:x.observacoes||null};c==="conta_fiada"&&(r!=null&&r.id)&&(N.cliente_id=r.id),c==="dinheiro"&&(N.valor_recebido=V);try{await ee.post("/gerenciamento/vendas",N,{preserveScroll:!0,headers:{"X-PDV-Inline":"true"},onSuccess:()=>{b({type:"success",title:"Venda Realizada",message:f.venda_processada}),g(),_("lista")},onError:j=>{Object.values(j).forEach(i=>{b({type:"error",title:"Erro na Venda",message:Array.isArray(i)?i[0]:i})})},onFinish:()=>{u(!1)}})}catch(j){console.error("ðŸ’¥ Erro crÃ­tico:",j),u(!1)}}});function Ye({vendas:a=[],produtos:n=[],clientes:t=[],error:c,messages:d}){const[r,m]=o.useState("lista"),{busca:g,setBusca:u,produtosFiltrados:_,limparBusca:b}=Pe(n),{filtroStatus:f,filtroCliente:y,filtroClienteTexto:x,setFiltroStatus:V,setFiltroCliente:N,setFiltroClienteTexto:j,vendasFiltradas:i,limparFiltros:s}=Be(a,t),[w,C]=o.useState(!1),[E,T]=o.useState(!1),[z,h]=o.useState(null),[p,v]=o.useState(!1),[F,S]=o.useState(!1),{notifications:R,addNotification:k,removeNotification:L}=Ve(),{finalizarVenda:l}=Oe(),{carrinho:D,clienteSelecionado:M,desconto:I,formaPagamento:P,valorRecebido:B,observacoes:ie,loadingVenda:U,setClienteSelecionado:K,setDesconto:re,setFormaPagamento:ce,setValorRecebido:oe,setObservacoes:de,setLoadingVenda:me,adicionarAoCarrinho:ue,editarQuantidade:he,removerDoCarrinho:xe,limparCarrinho:O,calcularSubtotal:be,calcularTotal:H,getDadosVenda:W}=Ae(d),{cancelarVenda:pe}=Le(),[fe,Y]=o.useState(t);o.useEffect(()=>{Y(t)},[t]);const je=()=>{C(!0)},X=()=>{C(!1)},ge=$=>{if(!$){X();return}Y(A=>A.some(we=>String(we.id)===String($.id))?A:[...A,$]),K($),X(),k&&k({type:"success",title:"Cliente",message:"Cliente cadastrado e selecionado no carrinho."})},Ne=()=>l({carrinho:D,calcularTotal:H,formaPagamento:P,valorRecebido:B,clienteSelecionado:M,getDadosVenda:W,limparCarrinho:O,setLoadingVenda:me,setAbaAtiva:m,addNotification:k,messages:d}),ve=async $=>{T(!0),v(!0),h({id:$.id});try{const A=await fetch(`/gerenciamento/vendas/${$.id}`,{headers:{Accept:"application/json"},credentials:"same-origin"});if(!A.ok)throw new Error("Erro ao carregar detalhes");const J=await A.json();h(J.venda)}catch{h($)}finally{v(!1)}},Ce=()=>{T(!1),h(null)},ye=()=>pe({carrinho:D,calcularTotal:H,formaPagamento:P,valorRecebido:B,clienteSelecionado:M,getDadosVenda:W,limparCarrinho:O,setCancelandoVenda:S,setAbaAtiva:m,addNotification:k,messages:d});return e.jsxs(Fe,{title:"Vendas",children:[e.jsx(Se,{title:"Vendas"}),e.jsx(De,{notifications:R,onRemove:L}),e.jsxs("div",{className:"container-fluid py-4",children:[c&&e.jsxs("div",{className:"alert alert-danger alert-dismissible fade show",role:"alert",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),c,e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"alert"})]}),e.jsxs("div",{className:"d-flex flex-column flex-lg-row justify-content-between align-items-lg-center elemento-vendas-header gap-lg-0 mb-4 gap-2",children:[e.jsxs("h2",{className:"elemento-vendas-titulo d-flex align-items-center mb-0 flex-nowrap gap-2",children:[e.jsx("i",{className:"bi bi-receipt text-primary fs-4"}),e.jsx("span",{className:"text-nowrap",children:"Vendas"})]}),e.jsxs("ul",{className:"nav nav-pills elemento-vendas-abas d-flex w-lg-auto mt-lg-0 justify-content-center justify-content-lg-end mt-2 w-100 flex-nowrap gap-2 overflow-auto",children:[e.jsx("li",{className:"nav-item",children:e.jsxs("button",{className:`nav-link ${r==="lista"?"active":""} elemento-vendas-aba-lista`,onClick:()=>m("lista"),children:[e.jsx("i",{className:"bi bi-list me-2"}),"HistÃ³rico"]})}),e.jsx("li",{className:"nav-item",children:e.jsxs("button",{className:`nav-link ${r==="nova"?"active":""} elemento-vendas-aba-nova`,onClick:()=>m("nova"),children:[e.jsx("i",{className:"bi bi-plus-circle me-2"}),"Nova Venda"]})})]})]}),r==="lista"?e.jsx("div",{className:"elemento-vendas-lista",children:e.jsx(qe,{clientes:t,filtroStatus:f,filtroCliente:y,filtroClienteTexto:x,setFiltroStatus:V,setFiltroCliente:N,setFiltroClienteTexto:j,vendasFiltradas:i,abrirDetalhes:ve,limparFiltros:s})}):null,r==="nova"?e.jsxs("div",{className:`row fade-in vendas-container ${U||F?"processing":""}`,children:[e.jsx("div",{className:"col-lg-8 mb-lg-0 col-12 mb-3",children:e.jsx(ze,{busca:g,setBusca:u,produtosFiltrados:_,limparBusca:b,adicionarAoCarrinho:ue,addNotification:k})}),e.jsx("div",{className:"col-lg-4 col-12",children:e.jsx(Me,{carrinho:D,clienteSelecionado:M,clientesAtualizados:fe,desconto:I,formaPagamento:P,valorRecebido:String(B),observacoes:ie,loadingVenda:U,setClienteSelecionado:K,setDesconto:re,setFormaPagamento:ce,setValorRecebido:oe,setObservacoes:de,editarQuantidade:he,removerDoCarrinho:xe,limparCarrinho:O,calcularSubtotal:be,calcularTotal:H,finalizarVenda:Ne,cancelarVenda:ye,cancelandoVenda:F,abrirModalCliente:je,addNotification:k})})]}):null]}),e.jsx(ke,{show:w,onClose:X,onSuccess:ge,carrinhoItens:D}),e.jsx(_e,{show:E,venda:z,loading:p,fechar:Ce})]})}export{Ye as default};
